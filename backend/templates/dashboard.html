{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - VitalCircle{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">VitalCircle Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                            <div class="w-10 rounded-full bg-primary text-primary-content flex items-center justify-center">
                                {{ user.first_name.0|default:user.username.0|upper }}
                            </div>
                        </div>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                            <li class="menu-title">
                                <span>{{ user.first_name }} {{ user.last_name }}</span>
                            </li>
                            <li><a href="/profile/">Profile</a></li>
                            <li><a href="/settings/">Settings</a></li>
                            <li><a href="{% url 'logout' %}">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Section -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900">
                Welcome back, {{ user.first_name|default:user.username }}!
            </h2>
            <p class="mt-2 text-gray-600">
                {% if user.userprofile.user_type == 'patient' %}
                    Monitor your health vitals and connect with healthcare providers.
                {% elif user.userprofile.user_type == 'clinician' %}
                    Manage your patients and review health data.
                {% else %}
                    Manage your healthcare journey with VitalCircle.
                {% endif %}
            </p>
            
            <!-- Debug Info (remove in production) -->
            <div class="mt-2 p-2 bg-gray-100 rounded text-sm">
                <strong>Debug:</strong> User Type: {{ user.userprofile.user_type|default:"No profile" }} | 
                User ID: {{ user.id }} | 
                Username: {{ user.username }}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            {% if user.userprofile.user_type == 'patient' %}
                <!-- Patient Stats -->
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-figure text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </div>
                        <div class="stat-title">Heart Rate</div>
                        <div class="stat-value text-primary">--</div>
                        <div class="stat-desc">Last reading</div>
                    </div>
                </div>
                
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-figure text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div class="stat-title">Blood Pressure</div>
                        <div class="stat-value text-secondary">--/--</div>
                        <div class="stat-desc">mmHg</div>
                    </div>
                </div>
                
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-figure text-accent">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="stat-title">Appointments</div>
                        <div class="stat-value text-accent">0</div>
                        <div class="stat-desc">Upcoming</div>
                    </div>
                </div>
                
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-figure text-info">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                            </svg>
                        </div>
                        <div class="stat-title">AI Insights</div>
                        <div class="stat-value text-info">0</div>
                        <div class="stat-desc">New recommendations</div>
                    </div>
                </div>
            {% else %}
                <!-- Clinician Stats -->
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-figure text-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div class="stat-title">Patients</div>
                        <div class="stat-value text-primary">0</div>
                        <div class="stat-desc">Active patients</div>
                    </div>
                </div>
                
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-figure text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="stat-title">Appointments</div>
                        <div class="stat-value text-secondary">0</div>
                        <div class="stat-desc">Today</div>
                    </div>
                </div>
                
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-figure text-accent">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                        <div class="stat-title">Reports</div>
                        <div class="stat-value text-accent">0</div>
                        <div class="stat-desc">Pending review</div>
                    </div>
                </div>
                
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-figure text-info">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="stat-title">Alerts</div>
                        <div class="stat-value text-info">0</div>
                        <div class="stat-desc">Critical alerts</div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title">Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        {% if user.userprofile.user_type == 'patient' %}
                            <button class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                </svg>
                                Log Vitals
                            </button>
                            <button class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Book Appointment
                            </button>
                            <button class="btn btn-accent" onclick="openMedicineAlertModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z" />
                                </svg>
                                Medicine Alerts
                            </button>
                            <button class="btn btn-info">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                AI Insights
                            </button>
                        {% else %}
                            <button class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                Manage Patients
                            </button>
                            <button class="btn btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Schedule
                            </button>
                            <button class="btn btn-accent">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Reports
                            </button>
                            <button class="btn btn-info">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Alerts
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title">Recent Activity</h3>
                    <div class="space-y-4 mt-4">
                        <div class="flex items-center space-x-3">
                            <div class="avatar placeholder">
                                <div class="bg-neutral-focus text-neutral-content rounded-full w-8">
                                    <span class="text-xs">AI</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-600">Welcome to VitalCircle! Your health journey starts here.</p>
                                <p class="text-xs text-gray-400">Just now</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medicine Alerts Section (Only for Patients) -->
        {% if user.userprofile.user_type == 'patient' %}
        <div class="card bg-base-100 shadow-xl mb-8 border-2 border-primary">
            <div class="card-body">
                <div class="flex justify-between items-center">
                    <h3 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z" />
                        </svg>
                        My Medicine Alerts
                        <div class="badge badge-primary">Patient Only</div>
                    </h3>
                    <button class="btn btn-primary btn-sm" onclick="openMedicineAlertModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Add Alert
                    </button>
                </div>
                
                <!-- Medicine Alerts List -->
                <div id="medicine-alerts-list" class="mt-4">
                    <div class="text-center py-8 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z" />
                        </svg>
                        <p>No medicine alerts set up yet.</p>
                        <p class="text-sm mt-2">Click "Add Alert" to start tracking your medications with AI-powered reminders.</p>
                    </div>
                </div>
                
                <!-- AI Nudges Section -->
                <div class="divider"></div>
                <div class="flex justify-between items-center">
                    <h4 class="font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-info inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        AI Health Nudges
                        <div class="badge badge-info">WebLLM Powered</div>
                    </h4>
                    <button class="btn btn-ghost btn-sm" onclick="initWebLLM()" id="webllm-init-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Enable AI
                    </button>
                </div>
                
                <div id="ai-nudges-list" class="mt-4">
                    <div class="text-center py-4 text-gray-500">
                        <p class="text-sm">AI-powered health nudges will appear here when available.</p>
                        <p class="text-xs mt-1">Click "Enable AI" to activate local AI assistant.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Health Assistant (Only for Patients) -->
        <div class="card bg-base-100 shadow-xl mb-8 border-2 border-accent">
            <div class="card-body">
                <div class="flex justify-between items-center">
                    <h3 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        AI Health Assistant
                        <div class="badge badge-accent">WebLLM</div>
                    </h3>
                    <div class="flex gap-2">
                        <div class="dropdown dropdown-end">
                            <button tabindex="0" class="btn btn-ghost btn-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                            <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li><a onclick="toggleWebLLMAssistant()">Toggle Assistant</a></li>
                                <li><a onclick="openWebLLMSettings()">AI Settings</a></li>
                                <li><a onclick="clearAIChatHistory()">Clear History</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- WebLLM Status -->
                <div class="flex items-center gap-4 mt-4 p-3 bg-base-200 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div id="webllm-status-indicator" class="loading loading-ring loading-sm text-warning"></div>
                        <span id="webllm-status-text" class="text-sm">Initializing AI...</span>
                    </div>
                    <div class="flex-1">
                        <div id="webllm-model-info" class="text-xs text-gray-500">No model loaded</div>
                    </div>
                    <button id="webllm-toggle-btn" class="btn btn-xs btn-primary" onclick="toggleWebLLMAssistant()" disabled>
                        <span id="webllm-toggle-text">Enable</span>
                    </button>
                </div>
                
                <!-- AI Chat Interface -->
                <div id="ai-chat-container" class="mt-4 hidden">
                    <div class="chat-container bg-base-200 rounded-lg p-4 h-64 overflow-y-auto mb-4" id="ai-chat-messages">
                        <div class="chat chat-start">
                            <div class="chat-image avatar">
                                <div class="w-10 rounded-full bg-accent text-accent-content flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="chat-header">
                                VitalCircle AI
                                <time class="text-xs opacity-50">Just now</time>
                            </div>
                            <div class="chat-bubble chat-bubble-accent">
                                Hello! I'm your AI health assistant. I can help you with medicine reminders, health education, and motivational support. How can I assist you today?
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button class="btn btn-outline btn-xs" onclick="sendQuickMessage('Check my medication list for interactions')">
                            💊 Drug Interactions
                        </button>
                        <button class="btn btn-outline btn-xs" onclick="sendQuickMessage('Explain my symptoms: headache and fatigue')">
                            🩺 Symptom Analysis
                        </button>
                        <button class="btn btn-outline btn-xs" onclick="sendQuickMessage('Provide clinical information about hypertension')">
                            � Medical Education
                        </button>
                        <button class="btn btn-outline btn-xs" onclick="sendQuickMessage('What are the side effects of my medications?')">
                            ⚠️ Side Effects
                        </button>
                        <button class="btn btn-outline btn-xs" onclick="sendQuickMessage('Create a medication adherence plan')">
                            � Adherence Plan
                        </button>
                        <button class="btn btn-outline btn-xs" onclick="sendQuickMessage('When should I seek emergency care?')">
                            🚨 Emergency Signs
                        </button>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="flex gap-2">
                        <input type="text" id="ai-chat-input" placeholder="Ask about your health, medications, or get support..." 
                               class="input input-bordered flex-1" 
                               onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendChatMessage()" id="ai-send-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- AI Progress (when generating) -->
                <div id="ai-generation-progress" class="mt-4 hidden">
                    <div class="flex items-center gap-2">
                        <div class="loading loading-dots loading-sm"></div>
                        <span class="text-sm">AI is thinking...</span>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <!-- Clinician Dashboard Features -->
        <div class="card bg-base-100 shadow-xl mb-8">
            <div class="card-body">
                <h3 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Patient Management
                    <div class="badge badge-secondary">Clinician</div>
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                    <div class="stat bg-base-200 rounded-lg">
                        <div class="stat-title">Active Patients</div>
                        <div class="stat-value text-primary">0</div>
                        <div class="stat-desc">Under your care</div>
                    </div>
                    
                    <div class="stat bg-base-200 rounded-lg">
                        <div class="stat-title">Critical Alerts</div>
                        <div class="stat-value text-error">0</div>
                        <div class="stat-desc">Require attention</div>
                    </div>
                    
                    <div class="stat bg-base-200 rounded-lg">
                        <div class="stat-title">Today's Schedule</div>
                        <div class="stat-value text-info">0</div>
                        <div class="stat-desc">Appointments</div>
                    </div>
                </div>
                
                <div class="divider"></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button class="btn btn-outline btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        View All Patients
                    </button>
                    
                    <button class="btn btn-outline btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Patient Reports
                    </button>
                    
                    <button class="btn btn-outline btn-accent">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Schedule Management
                    </button>
                    
                    <button class="btn btn-outline btn-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.464 0L4.268 16.5c-.77.833.192 2.5 1.732 2.5z" />
                        </svg>
                        Critical Alerts
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Getting Started -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h3 class="card-title">Getting Started</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                    {% if user.userprofile.user_type == 'patient' %}
                        <div class="text-center p-4">
                            <div class="w-16 h-16 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <h4 class="font-semibold mb-2">Complete Your Profile</h4>
                            <p class="text-sm text-gray-600">Add your medical history and contact information</p>
                        </div>
                        <div class="text-center p-4">
                            <div class="w-16 h-16 bg-secondary bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                            </div>
                            <h4 class="font-semibold mb-2">Log Your First Vitals</h4>
                            <p class="text-sm text-gray-600">Start tracking your health metrics</p>
                        </div>
                        <div class="text-center p-4">
                            <div class="w-16 h-16 bg-accent bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <h4 class="font-semibold mb-2">Schedule Appointment</h4>
                            <p class="text-sm text-gray-600">Connect with healthcare providers</p>
                        </div>
                    {% else %}
                        <div class="text-center p-4">
                            <div class="w-16 h-16 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                            </div>
                            <h4 class="font-semibold mb-2">Set Up Your Practice</h4>
                            <p class="text-sm text-gray-600">Add your credentials and specializations</p>
                        </div>
                        <div class="text-center p-4">
                            <div class="w-16 h-16 bg-secondary bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <h4 class="font-semibold mb-2">Add Patients</h4>
                            <p class="text-sm text-gray-600">Start building your patient list</p>
                        </div>
                        <div class="text-center p-4">
                            <div class="w-16 h-16 bg-accent bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <h4 class="font-semibold mb-2">Configure Schedule</h4>
                            <p class="text-sm text-gray-600">Set your availability for appointments</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Medicine Alert Modal -->
<dialog id="medicine-alert-modal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-primary inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z" />
            </svg>
            Add Medicine Alert
        </h3>
        
        <form id="medicine-alert-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Medicine Name -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Medicine Name *</span>
                    </label>
                    <input type="text" name="medicine_name" class="input input-bordered" placeholder="e.g., Lisinopril" required>
                </div>
                
                <!-- Dosage -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Dosage *</span>
                    </label>
                    <input type="text" name="dosage" class="input input-bordered" placeholder="e.g., 10mg" required>
                </div>
                
                <!-- Form -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Form</span>
                    </label>
                    <select name="form" class="select select-bordered">
                        <option value="tablet">Tablet</option>
                        <option value="capsule">Capsule</option>
                        <option value="liquid">Liquid</option>
                        <option value="injection">Injection</option>
                        <option value="cream">Cream</option>
                        <option value="patch">Patch</option>
                        <option value="inhaler">Inhaler</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <!-- Priority -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Priority</span>
                    </label>
                    <select name="priority" class="select select-bordered">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                
                <!-- Times per day -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Times per day</span>
                    </label>
                    <input type="number" name="times_per_day" class="input input-bordered" min="1" max="6" value="1">
                </div>
                
                <!-- Alert Type -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Alert Type</span>
                    </label>
                    <select name="alert_type" class="select select-bordered">
                        <option value="daily" selected>Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="as_needed">As Needed</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <!-- Start Date -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Start Date *</span>
                    </label>
                    <input type="date" name="start_date" class="input input-bordered" required>
                </div>
                
                <!-- End Date -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">End Date</span>
                    </label>
                    <input type="date" name="end_date" class="input input-bordered">
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="form-control mt-4">
                <label class="label">
                    <span class="label-text">Instructions</span>
                </label>
                <textarea name="instructions" class="textarea textarea-bordered" placeholder="e.g., Take with food"></textarea>
            </div>
            
            <!-- Alert Times -->
            <div class="form-control mt-4">
                <label class="label">
                    <span class="label-text">Alert Times</span>
                </label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="alert-times-container">
                    <input type="time" name="alert_time_1" class="input input-bordered input-sm" value="08:00">
                </div>
                <button type="button" class="btn btn-ghost btn-sm mt-2" onclick="addAlertTime()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Add Time
                </button>
            </div>
            
            <!-- AI Nudges -->
            <div class="form-control mt-4">
                <label class="cursor-pointer label">
                    <span class="label-text">Enable AI-powered nudges</span>
                    <input type="checkbox" name="enable_ai_nudges" class="toggle toggle-primary" checked>
                </label>
            </div>
            
            <div class="modal-action">
                <button type="button" class="btn" onclick="document.getElementById('medicine-alert-modal').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Create Alert
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Include WebLLM Service -->
<script src="{% static 'js/webllm-service.js' %}"></script>

<script>
// Global variables
let webllmService = null;
let alertTimeCounter = 1;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded for user type: {{ user.userprofile.user_type|default:"unknown" }}');
    console.log('User ID: {{ user.id }}, Username: {{ user.username }}');
    
    // Set today as default start date
    const today = new Date().toISOString().split('T')[0];
    const startDateInput = document.querySelector('input[name="start_date"]');
    if (startDateInput) {
        startDateInput.value = today;
    }
    
    // Only load medicine alerts for patients
    {% if user.userprofile.user_type == 'patient' %}
        console.log('Loading patient features: medicine alerts and AI nudges');
        // Load existing medicine alerts
        loadMedicineAlerts();
        
        // Load AI nudges
        loadAINudges();
        
        // Setup form submission
        const alertForm = document.getElementById('medicine-alert-form');
        if (alertForm) {
            alertForm.addEventListener('submit', handleMedicineAlertSubmit);
        }
    {% else %}
        console.log('User is not a patient - skipping medicine alerts');
    {% endif %}
});

// Open medicine alert modal
function openMedicineAlertModal() {
    document.getElementById('medicine-alert-modal').showModal();
}

// Add alert time input
function addAlertTime() {
    alertTimeCounter++;
    const container = document.getElementById('alert-times-container');
    const timeInput = document.createElement('input');
    timeInput.type = 'time';
    timeInput.name = `alert_time_${alertTimeCounter}`;
    timeInput.className = 'input input-bordered input-sm';
    container.appendChild(timeInput);
}

// Handle medicine alert form submission
async function handleMedicineAlertSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const alertData = {
        medicine_name: formData.get('medicine_name'),
        dosage: formData.get('dosage'),
        form: formData.get('form'),
        instructions: formData.get('instructions'),
        alert_type: formData.get('alert_type'),
        times_per_day: parseInt(formData.get('times_per_day')),
        priority: formData.get('priority'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date') || null,
        enable_ai_nudges: formData.get('enable_ai_nudges') === 'on',
        alert_times: []
    };
    
    // Collect alert times
    const timeInputs = document.querySelectorAll('input[name^="alert_time_"]');
    timeInputs.forEach(input => {
        if (input.value) {
            alertData.alert_times.push(input.value);
        }
    });
    
    try {
        const response = await fetch('/ai/api/medicine-alerts/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(alertData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success toast
            showToast('Medicine alert created successfully!', 'success');
            
            // Close modal and reset form
            document.getElementById('medicine-alert-modal').close();
            e.target.reset();
            alertTimeCounter = 1;
            
            // Reload alerts
            loadMedicineAlerts();
        } else {
            showToast('Error creating alert: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Network error occurred', 'error');
    }
}

// Load medicine alerts
async function loadMedicineAlerts() {
    try {
        const response = await fetch('/ai/api/medicine-alerts/');
        const result = await response.json();
        
        if (result.success) {
            displayMedicineAlerts(result.alerts);
        }
    } catch (error) {
        console.error('Error loading alerts:', error);
    }
}

// Display medicine alerts
function displayMedicineAlerts(alerts) {
    const container = document.getElementById('medicine-alerts-list');
    
    if (alerts.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 7.172V5L8 4z" />
                </svg>
                <p>No medicine alerts set up yet.</p>
                <p class="text-sm mt-2">Click "Add Alert" to start tracking your medications with AI-powered reminders.</p>
            </div>
        `;
        return;
    }
    
    const alertsHtml = alerts.map(alert => `
        <div class="card bg-base-200 mb-4">
            <div class="card-body p-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h5 class="font-semibold text-lg">${alert.medicine_name}</h5>
                        <p class="text-sm opacity-70">${alert.dosage} • ${alert.form}</p>
                        <div class="flex items-center mt-2 gap-4">
                            <div class="badge badge-${getPriorityColor(alert.priority)}">${alert.priority}</div>
                            <span class="text-sm">${alert.times_per_day}x daily</span>
                            ${alert.enable_ai_nudges ? '<span class="text-sm text-info">🤖 AI Enabled</span>' : ''}
                        </div>
                        ${alert.alert_times.length > 0 ? `
                            <div class="mt-2">
                                <span class="text-sm font-medium">Times: </span>
                                ${alert.alert_times.map(time => `<span class="badge badge-outline badge-sm mr-1">${time}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-ghost btn-sm" onclick="generateAINudge(${alert.id})">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="recordIntake(${alert.id})">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </button>
                    </div>
                </div>
                ${alert.instructions ? `<p class="text-sm mt-2 italic">${alert.instructions}</p>` : ''}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = alertsHtml;
}

// Get priority color for badge
function getPriorityColor(priority) {
    const colors = {
        'low': 'info',
        'medium': 'warning', 
        'high': 'error',
        'critical': 'error'
    };
    return colors[priority] || 'neutral';
}

// Initialize WebLLM
async function initWebLLM() {
    const button = document.getElementById('webllm-init-btn');
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Initializing...';
        button.disabled = true;
        
        if (!webllmService) {
            webllmService = new VitalCircleWebLLM();
        }
        
        await webllmService.initialize();
        
        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> AI Ready';
        button.disabled = false;
        
        showToast('AI assistant is ready!', 'success');
    } catch (error) {
        console.error('Error initializing WebLLM:', error);
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('Failed to initialize AI assistant', 'error');
    }
}

// Generate AI nudge for medicine
async function generateAINudge(alertId) {
    if (!webllmService) {
        showToast('Please initialize AI first', 'warning');
        return;
    }
    
    try {
        showToast('Generating personalized health nudge...', 'info');
        
        // Create nudge record
        const response = await fetch('/ai/api/ai-nudges/generate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                alert_id: alertId,
                nudge_type: 'medicine_reminder'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Generate nudge with WebLLM
            const nudgeMessage = await webllmService.generateMedicineNudge(result.context);
            
            // Update nudge with generated content
            await fetch(`/ai/api/ai-nudges/${result.nudge_id}/update/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: nudgeMessage.message,
                    action_suggestion: nudgeMessage.actionSuggestion,
                    generation_tokens: nudgeMessage.stats?.tokens || 0,
                    generation_time_ms: nudgeMessage.stats?.timeMs || 0
                })
            });
            
            // Reload AI nudges
            loadAINudges();
            
            showToast('Personalized health nudge generated!', 'success');
        }
    } catch (error) {
        console.error('Error generating nudge:', error);
        showToast('Failed to generate nudge', 'error');
    }
}

// Record medicine intake
async function recordIntake(alertId) {
    try {
        const response = await fetch('/ai/api/medicine-intake/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                alert_id: alertId,
                scheduled_time: new Date().toISOString(),
                status: 'taken'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Medicine intake recorded!', 'success');
        } else {
            showToast('Error recording intake: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Network error occurred', 'error');
    }
}

// Load AI nudges
async function loadAINudges() {
    try {
        const response = await fetch('/ai/api/ai-nudges/');
        const result = await response.json();
        
        if (result.success) {
            displayAINudges(result.nudges);
        }
    } catch (error) {
        console.error('Error loading nudges:', error);
    }
}

// Display AI nudges
function displayAINudges(nudges) {
    const container = document.getElementById('ai-nudges-list');
    
    if (nudges.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <p class="text-sm">AI-powered health nudges will appear here when available.</p>
            </div>
        `;
        return;
    }
    
    const nudgesHtml = nudges.map(nudge => `
        <div class="alert alert-info mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <div class="flex-1">
                <h3 class="font-bold">${nudge.title}</h3>
                <div class="text-sm">${nudge.message}</div>
                ${nudge.action_suggestion ? `<div class="text-xs mt-1 opacity-70">${nudge.action_suggestion}</div>` : ''}
            </div>
            <div class="flex gap-2">
                <button class="btn btn-ghost btn-sm" onclick="dismissNudge(${nudge.id})">Dismiss</button>
                <button class="btn btn-primary btn-sm" onclick="actOnNudge(${nudge.id})">Take Action</button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = nudgesHtml;
}

// Dismiss nudge
async function dismissNudge(nudgeId) {
    try {
        await fetch(`/ai/api/ai-nudges/${nudgeId}/interaction/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                interaction_type: 'dismissed'
            })
        });
        
        loadAINudges();
    } catch (error) {
        console.error('Error dismissing nudge:', error);
    }
}

// Act on nudge
async function actOnNudge(nudgeId) {
    try {
        await fetch(`/ai/api/ai-nudges/${nudgeId}/interaction/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                interaction_type: 'acted_upon',
                action_type: 'button_click'
            })
        });
        
        showToast('Action recorded! Keep up the great work!', 'success');
        loadAINudges();
    } catch (error) {
        console.error('Error recording action:', error);
    }
}

// Show toast notification
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} fixed top-4 right-4 w-auto max-w-sm z-50 shadow-lg`;
    toast.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Get CSRF cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// AI Health Assistant Functions
let webllmInitialized = false;
let chatHistory = [];

// Initialize WebLLM on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeWebLLMInterface();
});

async function initializeWebLLMInterface() {
    const statusIndicator = document.getElementById('webllm-status-indicator');
    const statusText = document.getElementById('webllm-status-text');
    const toggleBtn = document.getElementById('webllm-toggle-btn');
    const modelInfo = document.getElementById('webllm-model-info');
    
    try {
        // Check if WebLLM service exists
        if (typeof VitalCircleWebLLM === 'undefined') {
            statusIndicator.className = 'w-3 h-3 bg-error rounded-full';
            statusText.textContent = 'WebLLM service not found';
            return;
        }
        
        // Initialize the service
        if (!webllmService) {
            webllmService = new VitalCircleWebLLM();
        }
        
        // Set up progress callback
        webllmService.setProgressCallback((progress) => {
            statusText.textContent = progress.text;
        });
        
        // Check WebGPU support
        const hasWebGPU = await webllmService.checkWebGPUSupport();
        if (!hasWebGPU) {
            statusIndicator.className = 'w-3 h-3 bg-warning rounded-full';
            statusText.textContent = 'WebGPU not supported - AI features limited';
            modelInfo.textContent = 'WebGPU required for AI functionality';
            return;
        }
        
        // Check for cached models
        const cachedModels = webllmService.getCachedModels();
        if (cachedModels.length > 0) {
            statusIndicator.className = 'w-3 h-3 bg-success rounded-full';
            statusText.textContent = 'AI models available';
            modelInfo.textContent = `${cachedModels.length} model(s) cached`;
            toggleBtn.disabled = false;
        } else {
            statusIndicator.className = 'w-3 h-3 bg-warning rounded-full';
            statusText.textContent = 'No AI models cached';
            modelInfo.textContent = 'Click "Enable" to download a model';
            toggleBtn.disabled = false;
        }
        
    } catch (error) {
        console.error('WebLLM initialization error:', error);
        statusIndicator.className = 'w-3 h-3 bg-error rounded-full';
        statusText.textContent = 'AI initialization failed';
        modelInfo.textContent = error.message;
    }
}

async function toggleWebLLMAssistant() {
    const toggleBtn = document.getElementById('webllm-toggle-btn');
    const toggleText = document.getElementById('webllm-toggle-text');
    const chatContainer = document.getElementById('ai-chat-container');
    const statusIndicator = document.getElementById('webllm-status-indicator');
    const statusText = document.getElementById('webllm-status-text');
    
    if (!webllmInitialized) {
        // Enable AI
        toggleBtn.disabled = true;
        toggleText.textContent = 'Loading...';
        statusIndicator.className = 'loading loading-ring loading-sm text-warning';
        statusText.textContent = 'Loading AI model...';
        
        try {
            const success = await webllmService.initialize();
            if (success) {
                webllmInitialized = true;
                chatContainer.classList.remove('hidden');
                toggleText.textContent = 'Disable';
                statusIndicator.className = 'w-3 h-3 bg-success rounded-full';
                statusText.textContent = 'AI Assistant Ready';
                document.getElementById('webllm-model-info').textContent = `Model: ${webllmService.getCurrentModel()}`;
                
                showToast('AI Health Assistant activated!', 'success');
            } else {
                throw new Error('Failed to initialize AI model');
            }
        } catch (error) {
            console.error('Failed to enable AI:', error);
            statusIndicator.className = 'w-3 h-3 bg-error rounded-full';
            statusText.textContent = 'AI activation failed';
            showToast('Failed to activate AI assistant', 'error');
        }
        
        toggleBtn.disabled = false;
    } else {
        // Disable AI
        webllmInitialized = false;
        chatContainer.classList.add('hidden');
        toggleText.textContent = 'Enable';
        statusIndicator.className = 'w-3 h-3 bg-warning rounded-full';
        statusText.textContent = 'AI Assistant Disabled';
        
        showToast('AI Health Assistant disabled', 'info');
    }
}

function sendQuickMessage(message) {
    const chatInput = document.getElementById('ai-chat-input');
    chatInput.value = message;
    sendChatMessage();
}

async function sendChatMessage() {
    const chatInput = document.getElementById('ai-chat-input');
    const message = chatInput.value.trim();
    
    if (!message || !webllmInitialized) return;
    
    // Add user message to chat
    addMessageToChat('user', message);
    chatInput.value = '';
    
    // Show AI thinking indicator
    const progressDiv = document.getElementById('ai-generation-progress');
    progressDiv.classList.remove('hidden');
    
    // Disable send button
    const sendBtn = document.getElementById('ai-send-btn');
    sendBtn.disabled = true;
    
    try {
        // Add message to history
        chatHistory.push({ role: 'user', content: message });
        
        // Generate AI response
        let aiResponse = '';
        const generator = webllmService.generateResponse(chatHistory);
        
        // Add AI message bubble (will be updated with streaming text)
        const aiMessageDiv = addMessageToChat('ai', 'Thinking...');
        const aiMessageContent = aiMessageDiv.querySelector('.chat-bubble');
        
        // Stream the response
        for await (const chunk of generator) {
            aiResponse += chunk;
            aiMessageContent.textContent = aiResponse;
            
            // Auto-scroll to bottom
            const chatContainer = document.getElementById('ai-chat-messages');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Add AI response to history
        chatHistory.push({ role: 'assistant', content: aiResponse });
        
        // Keep chat history manageable (last 10 messages)
        if (chatHistory.length > 10) {
            chatHistory = chatHistory.slice(-10);
        }
        
    } catch (error) {
        console.error('AI generation error:', error);
        addMessageToChat('ai', 'Sorry, I encountered an error. Please try again.');
        showToast('AI response failed', 'error');
    } finally {
        // Hide thinking indicator and re-enable send button
        progressDiv.classList.add('hidden');
        sendBtn.disabled = false;
    }
}

function addMessageToChat(sender, message) {
    const chatContainer = document.getElementById('ai-chat-messages');
    const isUser = sender === 'user';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat ${isUser ? 'chat-end' : 'chat-start'}`;
    
    const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.innerHTML = `
        <div class="chat-image avatar">
            <div class="w-10 rounded-full ${isUser ? 'bg-primary text-primary-content' : 'bg-accent text-accent-content'} flex items-center justify-center">
                ${isUser ? 
                    '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>' :
                    '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>'
                }
            </div>
        </div>
        <div class="chat-header">
            ${isUser ? 'You' : 'VitalCircle AI'}
            <time class="text-xs opacity-50">${currentTime}</time>
        </div>
        <div class="chat-bubble ${isUser ? 'chat-bubble-primary' : 'chat-bubble-accent'}">${message}</div>
    `;
    
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    return messageDiv;
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatMessage();
    }
}

function clearAIChatHistory() {
    chatHistory = [];
    const chatContainer = document.getElementById('ai-chat-messages');
    chatContainer.innerHTML = `
        <div class="chat chat-start">
            <div class="chat-image avatar">
                <div class="w-10 rounded-full bg-accent text-accent-content flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
            </div>
            <div class="chat-header">
                VitalCircle AI
                <time class="text-xs opacity-50">Just now</time>
            </div>
            <div class="chat-bubble chat-bubble-accent">
                Hello! I'm your AI health assistant. I can help you with medicine reminders, health education, and motivational support. How can I assist you today?
            </div>
        </div>
    `;
    showToast('Chat history cleared', 'info');
}

function openWebLLMSettings() {
    // Open the WebLLM test page in a new tab for advanced settings
    window.open('/webllm-test/', '_blank');
}
</script>
{% endblock %}